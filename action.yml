name: 'Skyhook Kustomize Smart Deploy'
description: 'Complete kustomize deployment with GitOps detection and metadata extraction'
author: 'Skyhook'

branding:
  icon: 'package'
  color: 'purple'

inputs:
  working_directory:
    description: 'Working directory for operations'
    required: false
    default: '.'
  overlay_dir:
    description: 'Path to kustomize overlay directory (relative to working_directory)'
    required: true
  service_name:
    description: 'Service name'
    required: true
  image:
    description: 'Container image (e.g., registry.io/app or registry.io/app:v1.2.3)'
    required: false
  tag:
    description: 'Image tag (e.g., v1.2.3, latest, sha-abc123)'
    required: false
  images_json:
    description: 'Multiple images as JSON array: [{"name":"registry.io/app","newTag":"v1.2.3"}]'
    required: false
  environment:
    description: 'Environment name'
    required: true
  actor:
    description: 'User deploying (defaults to github.actor)'
    required: false
    default: ''
  run_id:
    description: 'Run ID for tracking (defaults to github.run_id)'
    required: false
    default: ''
  detect_gitops:
    description: 'Auto-detect GitOps mode from manifests'
    required: false
    default: 'true'
  force_mode:
    description: 'Force deployment mode (gitops, kubectl, or auto)'
    required: false
    default: 'auto'
  commit_message:
    description: 'Commit message for GitOps (has defaults)'
    required: false
  create_namespace:
    description: 'Create namespace if it does not exist'
    required: false
    default: 'true'
  wait_timeout:
    description: 'Timeout for waiting on deployments (seconds)'
    required: false
    default: '120'
  env_patches:
    description: 'Environment file patches (JSON format matching patch-env-files, e.g., {"container.env":{"SENTRY_RELEASE":"v1.2.3"}})'
    required: false

outputs:
  mode:
    description: 'Deployment mode used (gitops or kubectl)'
    value: ${{ steps.mode.outputs.mode }}
  namespace:
    description: 'Kubernetes namespace'
    value: ${{ steps.inspect.outputs.namespace }}
  deployment:
    description: 'Primary deployment name'
    value: ${{ steps.inspect.outputs.primary_deployment }}
  workloads_json:
    description: 'JSON array of deployed workloads: [{kind,name,namespace}]'
    value: ${{ steps.inspect.outputs.workloads_json }}
  managed_by:
    description: 'Value of managed-by label if found'
    value: ${{ steps.detect.outputs.managed_by }}

runs:
  using: 'composite'
  steps:
    - name: Validate inputs
      shell: bash
      run: |
        if [ ! -d "${{ inputs.working_directory }}/${{ inputs.overlay_dir }}" ]; then
          echo "::error::Overlay directory not found: ${{ inputs.working_directory }}/${{ inputs.overlay_dir }}"
          exit 1
        fi

        if [ ! -f "${{ inputs.working_directory }}/${{ inputs.overlay_dir }}/kustomization.yaml" ]; then
          echo "::error::No kustomization.yaml found in overlay directory"
          exit 1
        fi

    - name: Update kustomize manifests
      uses: skyhook-io/kustomize-edit@v1
      with:
        overlay_dir: ${{ inputs.working_directory }}/${{ inputs.overlay_dir }}
        image: ${{ inputs.image }}
        tag: ${{ inputs.tag }}
        images_json: ${{ inputs.images_json }}
        version_label: ${{ inputs.tag }}
        annotations: |
          last-deployed-by=${{ inputs.actor || github.actor }}
          deployment-timestamp=${{ github.event.head_commit.timestamp || github.run_id }}
          deployment-id=${{ inputs.run_id || github.run_id }}
          build.run.url=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env_patches: ${{ inputs.env_patches }}
    
    - name: Inspect kustomization
      id: inspect
      uses: skyhook-io/kustomize-inspect@v1
      with:
        overlay_dir: ${{ inputs.working_directory }}/${{ inputs.overlay_dir }}
    
    - name: Detect GitOps mode
      id: detect
      if: ${{ inputs.force_mode == 'auto' && inputs.detect_gitops == 'true' }}
      shell: bash
      working-directory: ${{ inputs.working_directory }}/${{ inputs.overlay_dir }}
      run: |
        echo "Detecting deployment mode..."
        
        BUILD_RESULT=$(kustomize build)
        MANAGED_BY=$(echo "$BUILD_RESULT" | grep "app.kubernetes.io/managed-by:" | head -n1 | sed 's/.*app.kubernetes.io\/managed-by:\s*//' | tr -d '[:space:]' || true)
        
        echo "managed_by=$MANAGED_BY" >> $GITHUB_OUTPUT
        
        if [ "$MANAGED_BY" = "argocd" ]; then
          echo "mode=gitops" >> $GITHUB_OUTPUT
          echo "‚úì GitOps mode detected (ArgoCD)"
        elif [ "$MANAGED_BY" = "flux" ]; then
          echo "mode=gitops" >> $GITHUB_OUTPUT
          echo "‚úì GitOps mode detected (Flux)"
        else
          echo "mode=kubectl" >> $GITHUB_OUTPUT
          echo "‚úì Direct deployment mode (kubectl)"
        fi
    
    - name: Set deployment mode
      id: mode
      shell: bash
      run: |
        if [ "${{ inputs.force_mode }}" != "auto" ]; then
          echo "mode=${{ inputs.force_mode }}" >> $GITHUB_OUTPUT
          echo "<> Using forced mode: ${{ inputs.force_mode }}"
        else
          echo "mode=${{ steps.detect.outputs.mode }}" >> $GITHUB_OUTPUT
        fi

    - name: Deployment context
      shell: bash
      run: |
        echo "=================================================="
        echo "üéØ Environment: ${{ inputs.environment }}"
        echo "üìÅ Overlay: ${{ inputs.overlay_dir }}"
        echo "üöÄ Mode: ${{ steps.mode.outputs.mode }}"
        echo "=================================================="

    - name: Deployment plan summary
      shell: bash
      working-directory: ${{ inputs.working_directory }}/${{ inputs.overlay_dir }}
      run: |
        KUSTOMIZE_BUILD_RESULT=$(kustomize build)
        echo "--- Deployment plan summary ---"
        echo "Deployment mode: ${{ steps.mode.outputs.mode }}"
        echo "KUSTOMIZE_BUILD_RESULT=$KUSTOMIZE_BUILD_RESULT"
        echo "--- Deployment plan summary ---"
        
    # GitOps path: commit changes
    - name: Commit changes for GitOps
      if: ${{ steps.mode.outputs.mode == 'gitops' }}
      uses: skyhook-io/git-sync-commit@v1
      with:
        path: ${{ inputs.working_directory }}
        commit_message: ${{ inputs.commit_message || format('Deploy {0} to {1} [skip ci]', inputs.service_name, inputs.environment) }}
        file_pattern: ${{ inputs.overlay_dir }}/*
    
    # Kubectl path: direct apply
    - name: Apply with kubectl
      if: ${{ steps.mode.outputs.mode == 'kubectl' }}
      uses: skyhook-io/kustomize-apply@v1
      with:
        overlay_dir: ${{ inputs.working_directory }}/${{ inputs.overlay_dir }}
        namespace: ${{ steps.inspect.outputs.namespace }}
        workloads_json: ${{ steps.inspect.outputs.workloads_json }}
        wait: 'true'
        wait_timeout: ${{ inputs.wait_timeout }}